{
  "page_content": "### Step 7: Define State and Data Models  \nCreate the state structure for conversation tracking and agent execution.  \n```python\nfrom langgraph.graph import MessagesState\nfrom pydantic import BaseModel, Field\nfrom typing import List, Annotated, Set\nimport operator\n\ndef accumulate_or_reset(existing: List[dict], new: List[dict]) -> List[dict]:\nif new and any(item.get('__reset__') for item in new):\nreturn []\nreturn existing + new\n\ndef set_union(a: Set[str], b: Set[str]) -> Set[str]:\nreturn a | b\n\nclass State(MessagesState):\nquestionIsClear: bool = False\nconversation_summary: str = \"\"\noriginalQuery: str = \"\"\nrewrittenQuestions: List[str] = []\nagent_answers: Annotated[List[dict], accumulate_or_reset] = []\n\nclass AgentState(MessagesState):\ntool_call_count: Annotated[int, operator.add] = 0\niteration_count: Annotated[int, operator.add] = 0\nquestion: str = \"\"\nquestion_index: int = 0\ncontext_summary: str = \"\"\nretrieval_keys: Annotated[Set[str], set_union] = set()\nfinal_answer: str = \"\"\nagent_answers: List[dict] = []\n\nclass QueryAnalysis(BaseModel):\nis_clear: bool = Field(description=\"Indicates if the user's question is clear and answerable.\")\nquestions: List[str] = Field(description=\"List of rewritten, self-contained questions.\")\nclarification_needed: str = Field(description=\"Explanation if the question is unclear.\")\n```  \n---\n\n### Step 8: Agent Configuration  \nHard limits on tool calls and iterations prevent infinite loops. Token counting (via `tiktoken`) drives context compression decisions.  \n```python\nimport tiktoken\n\nMAX_TOOL_CALLS = 8       # Maximum tool calls per agent run\nMAX_ITERATIONS = 10      # Maximum agent loop iterations\nBASE_TOKEN_THRESHOLD = 2000     # Initial token threshold for compression\nTOKEN_GROWTH_FACTOR = 0.9       # Multiplier applied after each compression\n\ndef estimate_context_tokens(messages: list) -> int:\ntry:\nencoding = tiktoken.encoding_for_model(\"gpt-4\")\nexcept:\nencoding = tiktoken.get_encoding(\"cl100k_base\")\nreturn sum(len(encoding.encode(str(msg.content))) for msg in messages if hasattr(msg, 'content') and msg.content)\n```  \n---",
  "metadata": {
    "H2": "Implementation -> Implementation",
    "H3": "Step 7: Define State and Data Models -> Step 8: Agent Configuration",
    "source": "Instruct.pdf",
    "parent_id": "Instruct_parent_8"
  }
}