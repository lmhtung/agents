{
  "page_content": "### Step 5: Define Agent Tools  \nCreate the retrieval tools the agent will use.  \n```python\nimport json\nfrom typing import List\nfrom langchain_core.tools import tool\n\n@tool\ndef search_child_chunks(query: str, limit: int) -> str:\n\"\"\"Search for the top K most relevant child chunks.\n\nArgs:\nquery: Search query string\nlimit: Maximum number of results to return\n\"\"\"\ntry:\nresults = child_vector_store.similarity_search(query, k=limit, score_threshold=0.7)\nif not results:\nreturn \"NO_RELEVANT_CHUNKS\"\n\nreturn \"\\n\\n\".join([\nf\"Parent ID: {doc.metadata.get('parent_id', '')}\\n\"\nf\"File Name: {doc.metadata.get('source', '')}\\n\"\nf\"Content: {doc.page_content.strip()}\"\nfor doc in results\n])\n\nexcept Exception as e:\nreturn f\"RETRIEVAL_ERROR: {str(e)}\"\n\n@tool\ndef retrieve_parent_chunks(parent_id: str) -> str:\n\"\"\"Retrieve full parent chunks by their IDs.\n\nArgs:\nparent_id: Parent chunk ID to retrieve\n\"\"\"\nfile_name = parent_id if parent_id.lower().endswith(\".json\") else f\"{parent_id}.json\"\npath = os.path.join(PARENT_STORE_PATH, file_name)\n\nif not os.path.exists(path):\nreturn \"NO_PARENT_DOCUMENT\"\n\nwith open(path, \"r\", encoding=\"utf-8\") as f:\ndata = json.load(f)\n\nreturn (\nf\"Parent ID: {parent_id}\\n\"\nf\"File Name: {data.get('metadata', {}).get('source', 'unknown')}\\n\"\nf\"Content: {data.get('page_content', '').strip()}\"\n)\n\nllm_with_tools = llm.bind_tools([search_child_chunks, retrieve_parent_chunks])\n```  \n---\n\n### Step 6: Define System Prompts  \nDefine the system prompts for conversation summarization, query rewriting, agent orchestration, context compression, fallback response, and answer aggregation.  \n<details>\n<summary>Conversation Summary Prompt</summary>  \n```python\ndef get_conversation_summary_prompt() -> str:\nreturn \"\"\"You are an expert conversation summarizer.\n\nYour task is to create a brief 1-2 sentence summary of the conversation (max 30-50 words).\n\nInclude:\n- Main topics discussed\n- Important facts or entities mentioned\n- Any unresolved questions if applicable\n- Sources file name (e.g., file1.pdf) or documents referenced\n\nExclude:\n- Greetings, misunderstandings, off-topic content.\n\nOutput:\n- Return ONLY the summary.\n- Do NOT include any explanations or justifications.\n- If no meaningful topics exist, return an empty string.\n\"\"\"\n```  \n</details>  \n<details>\n<summary>Query Rewrite Prompt</summary>  \n```python\ndef get_rewrite_query_prompt() -> str:\nreturn \"\"\"You are an expert query analyst and rewriter.\n\nYour task is to rewrite the current user query for optimal document retrieval, incorporating conversation context only when necessary.\n\nRules:\n1. Self-contained queries:\n- Always rewrite the query to be clear and self-contained\n- If the query is a follow-up (e.g., \"what about X?\", \"and for Y?\"), integrate minimal necessary context from the summary\n- Do not add information not present in the query or conversation summary\n\n2. Domain-specific terms:\n- Product names, brands, proper nouns, or technical terms are treated as domain-specific\n- For domain-specific queries, use conversation context minimally or not at all\n- Use the summary only to disambiguate vague queries\n\n3. Grammar and clarity:\n- Fix grammar, spelling errors, and unclear abbreviations\n- Remove filler words and conversational phrases\n- Preserve concrete keywords and named entities\n\n4. Multiple information needs:\n- If the query contains multiple distinct, unrelated questions, split into separate queries (maximum 3)\n- Each sub-query must remain semantically equivalent to its part of the original\n- Do not expand, enrich, or reinterpret the meaning\n\n5. Failure handling:\n- If the query intent is unclear or unintelligible, mark as \"unclear\"\n\nInput:\n- conversation_summary: A concise summary of prior conversation\n- current_query: The user's current query",
  "metadata": {
    "H2": "Implementation -> Implementation",
    "H3": "Step 5: Define Agent Tools -> Step 6: Define System Prompts",
    "source": "Instruct.pdf",
    "parent_id": "Instruct_parent_5"
  }
}