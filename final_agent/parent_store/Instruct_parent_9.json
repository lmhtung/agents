{
  "page_content": "### Step 9: Build Graph Node and Edge Functions  \nCreate the processing nodes and edges for the LangGraph workflow.  \n#### Main Graph Nodes & Edges\n```python\nfrom langgraph.types import Send, Command\nfrom langchain_core.messages import HumanMessage, AIMessage, SystemMessage, RemoveMessage, ToolMessage\nfrom typing import Literal\n\ndef summarize_history(state: State):\nif len(state[\"messages\"]) < 4:\nreturn {\"conversation_summary\": \"\"}\n\nrelevant_msgs = [\nmsg for msg in state[\"messages\"][:-1]\nif isinstance(msg, (HumanMessage, AIMessage)) and not getattr(msg, \"tool_calls\", None)\n]\n\nif not relevant_msgs:\nreturn {\"conversation_summary\": \"\"}\n\nconversation = \"Conversation history:\\n\"\nfor msg in relevant_msgs[-6:]:\nrole = \"User\" if isinstance(msg, HumanMessage) else \"Assistant\"\nconversation += f\"{role}: {msg.content}\\n\"\n\nsummary_response = llm.with_config(temperature=0.2).invoke([SystemMessage(content=get_conversation_summary_prompt()), HumanMessage(content=conversation)])\nreturn {\"conversation_summary\": summary_response.content, \"agent_answers\": [{\"__reset__\": True}]}\n\ndef rewrite_query(state: State):\nlast_message = state[\"messages\"][-1]\nconversation_summary = state.get(\"conversation_summary\", \"\")\n\ncontext_section = (f\"Conversation Context:\\n{conversation_summary}\\n\" if conversation_summary.strip() else \"\") + f\"User Query:\\n{last_message.content}\\n\"\n\nllm_with_structure = llm.with_config(temperature=0.1).with_structured_output(QueryAnalysis)\nresponse = llm_with_structure.invoke([SystemMessage(content=get_rewrite_query_prompt()), HumanMessage(content=context_section)])\n\nif response.questions and response.is_clear:\ndelete_all = [RemoveMessage(id=m.id) for m in state[\"messages\"] if not isinstance(m, SystemMessage)]\nreturn {\"questionIsClear\": True, \"messages\": delete_all, \"originalQuery\": last_message.content, \"rewrittenQuestions\": response.questions}\n\nclarification = response.clarification_needed if response.clarification_needed and len(response.clarification_needed.strip()) > 10 else \"I need more information to understand your question.\"\nreturn {\"questionIsClear\": False, \"messages\": [AIMessage(content=clarification)]}\n\ndef request_clarification(state: State):\nreturn {}\n\ndef route_after_rewrite(state: State) -> Literal[\"request_clarification\", \"agent\"]:\nif not state.get(\"questionIsClear\", False):\nreturn \"request_clarification\"\nelse:\nreturn [\nSend(\"agent\", {\"question\": query, \"question_index\": idx, \"messages\": []})\nfor idx, query in enumerate(state[\"rewrittenQuestions\"])\n]\n\ndef aggregate_answers(state: State):\nif not state.get(\"agent_answers\"):\nreturn {\"messages\": [AIMessage(content=\"No answers were generated.\")]}\n\nsorted_answers = sorted(state[\"agent_answers\"], key=lambda x: x[\"index\"])\n\nformatted_answers = \"\"\nfor i, ans in enumerate(sorted_answers, start=1):\nformatted_answers += (f\"\\nAnswer {i}:\\n\"f\"{ans['answer']}\\n\")\n\nuser_message = HumanMessage(content=f\"\"\"Original user question: {state[\"originalQuery\"]}\\nRetrieved answers:{formatted_answers}\"\"\")\nsynthesis_response = llm.invoke([SystemMessage(content=get_aggregation_prompt()), user_message])\nreturn {\"messages\": [AIMessage(content=synthesis_response.content)]}\n```  \n---  \n#### Agent Subgraph Nodes & Edges\n```python\ndef orchestrator(state: AgentState):\ncontext_summary = state.get(\"context_summary\", \"\").strip()\nsys_msg = SystemMessage(content=get_orchestrator_prompt())\nsummary_injection = (\n[HumanMessage(content=f\"[COMPRESSED CONTEXT FROM PRIOR RESEARCH]\\n\\n{context_summary}\")]\nif context_summary else []\n)\nif not state.get(\"messages\"):\nhuman_msg = HumanMessage(content=state[\"question\"])\nforce_search = HumanMessage(content=\"YOU MUST CALL 'search_child_chunks' AS THE FIRST STEP TO ANSWER THIS QUESTION.\")\nresponse = llm_with_tools.invoke([sys_msg] + summary_injection + [human_msg, force_search])\nreturn {\"messages\": [human_msg, response], \"tool_call_count\": len(response.tool_calls or []), \"iteration_count\": 1}",
  "metadata": {
    "H2": "Implementation",
    "H3": "Step 9: Build Graph Node and Edge Functions",
    "source": "Instruct.pdf",
    "parent_id": "Instruct_parent_9"
  }
}